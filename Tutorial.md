# 使用说明

## 一. 主页
1. `配置名称` - 选填 - 哪里都没有用到
2. `夜间翻倍红外时长` - 启用后才生效. 勾选后开放下面两个选择框
3. `白天时间点` - 这个时间之后被认为是白天
3. `晚上时间点` - 这个时间之后被认为是晚上

## 二. 设备配置
1. 点击右下角 `添加设备` 按钮来新建一行
2. 最左侧的把手可以上下拖拽行
3. 第一列为设备类型, 决定了之后的列的意义
4. `名称` - 选填 - 决定了在后台管理界面时看见的设备名字

---

以下是各设备的配置项:

### 灯
1. `通道` - 必填 - 表示继电器通道
2. `携带状态` - 见下文
3. `联动设备` - 见下文
4. `排斥设备` - 见下文

### 窗帘
1. `开` - 必填 - 表示窗帘开电机的继电器通道
2. `关` - 必填 - 表示窗帘关电机的继电器通道
3. `运行` - 必填 - 表示窗帘一次动作的电机运行时长

### 红外空调
1. `空调ID` - 必填 - 表示此空调所对应的温控器的ID

### 单管空调
1. `空调ID` - 必填 - 表示此空调所对应的温控器的ID
2. `水阀` - 必填 - 表示此空调控制水阀的继电器通道
3. `低风` - 必填 - 表示此空调控制低风速的继电器通道
4. `中风` - 必填 - 表示此空调控制中风速的继电器通道
5. `高风` - 必填 - 表示此空调控制高风速的继电器通道

### 485指令
1. `指令码` - 必填 - 只支持八字节无空格十六进制码, 如 `7FC0FFFF0080BD7E`
- 详见后文

### 继电器输出
1. `通道` - 必填 - 表示继电器通道
- 本质上与类型 `灯` 相同
- 如 `排风扇`, `插座` 就适合使用这个设备类型

### 干接点输出
1. `通道` - 必填 - 表示干接点输出通道
- 通常用于门牌上的指示灯, 如勿扰, 清理, 入住, 并为其配置 `携带状态`(见下)

### 门铃
1. `通道` - 必填 - 表示门铃的继电器通道
- 本质上与类型 `继电器输出` 相同, 但门铃太过特殊, 必须使用这个类型

### 蓝牙背景音乐
- 无配置项. 但如果想要控制房间内的背景音乐, 必须要存在这么一行, 相当于声明.

### 大部分设备都有的配置项
1. `携带状态` - 选填 - 当前设备 `开` 的时候, 为房间添加此状态; `关` 的时候, 删除房间的此状态
2. `联动设备` - 选填 - 当前设备 `开` 的时候, 打开联动设备; `关` 的时候, 关闭联动设备
3. `排斥设备` - 选填 - 当前设备 `开` 的时候, 关闭排斥设备

## 三. 动作组合
1. 点击右下角 `添加组合` 按钮来新建一个 `组合`
2. 最左侧有把手可以上下拖拽行
3. `是模式` - 只有开启, 才能将此组合视作真正意义上的 `情景模式`, 并出现在后台管理界面
4. `名称` - 选填 - 决定了在后台管理界面时看见的模式名字
5. `添加动作` - 点击后为当前组合添加一行动作, 详见下文

---
- 每一个组合可以拥有多个动作, 当此组合被调用时, 会从上到下执行动作.
- 每个动作左侧都有把手可以拖拽, 这将更改动作执行顺序
- 每个动作的第一个选择框, 表示这一个动作的 `操控目标`, 之前在 `设备配置` 页定义的所有设备都会在这里出现

---
根据 `操控目标` 的类型, 可以执行不同操作, 以下是部分设备的动作的解释:

### 灯控/继电器输出/干接点输出
- `反转` - 切换至另一种状态

### 红外空调/单管空调
- `开` - 这种方式开启的空调会固定使用默认设置的各种状态

### 485指令码
- `发送` - 这会往485总线里发送一次之前在 `设备配置` 页里写的 `指令码` 内容

### 蓝牙背景音乐
- `反转模式` - 这会让背景音乐在 `蓝牙模式` 与 `tf卡模式` 之间切换

### 门铃
- 门铃本质上与灯相同, 在 `开` 的时候才会响, 接着必须 `关` 了后下一次才能 `开`, `反转` 的其实意义不大

---
系统工具也属于 `操控目标`, 以下是它们的动作的解释:

### 更改心跳
- `插卡`
    - **点亮** 所有按键面板的背光
    - RCU将愿意处理所有按键输入
    - 为房间添加 `入住` 状态
    - 同步当前时间到485总线中

- `拔卡`
    - **熄灭** 所有按键面板的背光
    - RCU将无视大部分按键输入
    - 删除房间的 `入住` 状态

- `睡眠`
    - **熄灭** 所有按键的指示灯与背光
    - RCU仍然愿意处理所有按键输入
    - 之后按任意键都会重新点亮按键背光

### 房间状态
- `添加`, `删除`, `反转` - 除了 `SOS` 之外通常不直接使用, 比如 `入住` 会随着 `更改心跳-插卡/拔卡` 变化, 而其他更适合将状态绑定到门牌指示灯的 `携带状态` 上
- `如果存在此状态则跳出` - 常用的逻辑动作, 如果房间内存在目标状态, 就会直接中断当前 `组合`, 不再继续往下执行动作

### 延时
- 执行这一行后, 当前 `组合` 将会停下, 等待设置的时长后再继续往下执行动作

### 动作组合
- `调用` - 立即开始执行目标 `组合`, 原 `组合` 并不会等它执行完, 而是继续执行
- `中断` - 如果目标 `组合` 正在执行的话, 最长一秒后, 会强制中断目标 `组合`, 典型场景是中断正在 `延时` 的 `组合`
- `生成任意键执行` - 执行之后系统中会存在一个 `任意键标记`, 此后按下任何按键, 通常都会调用当时标记的目标 `组合`, 而并不执行按键原本的功能. 一次后失效. 多次生成标记则只会保留最后一个
- `删除任意键执行` - 如果系统中存在 `任意键标记`, 就会删除这个标记. 常用于在拔卡后清除可能未被触发的标记

### 房间快照
- `记录快照` - 会保存房间内大部分设备的状态与插拔卡状态
- `读取并删除快照` - 如果系统中存在快照的话, 会将 `灯`, `窗帘`, `空调`, `干接点输出`, `继电器输出` 的开关状态与房间的插拔卡状态恢复为快照中保存的状态
- `删除快照` - 如果系统中存在快照的话就删除快照
- `清除快照并跳出` - 如果系统中存在快照的话就删除快照, 并直接中断当前 `组合`, 如果没有快照则不会中断 `组合

### 按键指示灯
- `亮` - 点亮目标按键的指示灯
- `灭` - 熄灭目标按键的指示灯
- `亮1秒` - 点亮目标按键的指示灯1秒后熄灭
- 通常用于情景模式中, 点亮当前模式的按键指示灯并熄灭别的模式的按键指示灯, `亮1秒`可用于睡眠模式的按键

## 四. 输入配置
1. 点击右下角 `添加输入` 按钮来新建一个 `输入行`
2. 最左侧有把手可以上下拖拽行
3. `名称` - 选填
4. 每一个 `输入行` 根据不同的输入类型, 在被触发后会执行右侧配置的动作组, 与 `动作组合` 配置页的逻辑一样

第二列表示输入类型:
- `面板按键`
    - `面板ID` 与 `按键ID` - 必填 - 当RCU收到此按键的输入时会执行动作组
    - `指示灯同步于` - 选填 - 比如选择了灯A, 那么无论灯A以什么方式开或关, 这个按键的指示灯都会随之变化

- `干接点输入`
    - `通道` - 必填 - 表示干接点输入通道
    - `触发类型`
        - `低电平` 与 `高电平` - 目标通道的输入电平与此相符才会执行动作组
        - `红外触发` - 需要配置一个 `检测时长`, 当首次检测到活动时会执行动作组
        - `红外超时` - 当上面配置的 `检测时长` 持续范围内都没有再次检测到活动, 就会执行此动作组.
            - `红外触发` 与 `红外超时` 必须配套使用, 即创建两个 `输入行`, 填写相同 `通道`

- `语音输入`
    - `指令码` - 必填 - 只支持八字节无空格十六进制码, 如 `7F8016000100167E`, 当收到此指令码时会执行动作组

### 额外标记
- `拔卡时可用` - 只有拥有这个标记的 `输入行`, 才能在 `更改心跳-拔卡` 的状态下使用
    - 像门磁, 插拔卡这些输入, 基本都必须有这个标记, 除此之外像 `清理` 按键也常有这个标记
- `是插拔卡输入` - 全局必须有且只能有两个的标记, 分别配置给插卡输入与拔卡输入, 它们通常是两个 `输入行`, 要么分别配给 `低电平/高电平`, 要么是 `红外触发/红外超时`
- `是门磁输入` - 必须配置给门磁输入通道
- `是门铃输入` - 必须配置给门铃输入通道
- `忽略任意键执行` - 拥有此标记的 `输入行`, 会无视系统中可能存在的 `任意键标记`, 直接执行自己的功能

### 添加新轮次
一个 `输入行` 可以拥有多个动作组, 当触发此输入后, 执行第一个, 紧接着再触发一次就会执行下一个, 但中途如果触发了别的 `输入行`, 就会重置

## 五. 常见用法

### 1. 清理与勿扰
`设备配置` 页: 
- 类型(`干接点输出`), 名称(`门牌清理111`), 通道(`1`), 携带状态(`清理`), 排斥设备(`门牌勿扰asd`)
- 类型(`干接点输出`), 名称(`门牌勿扰asd`), 通道(`2`), 携带状态(`勿扰`), 排斥设备(`门牌清理111`)

然后在任何动作组合中, 对 `门牌清理111` 调用 `开` 操作, 就会为房间添加 `清理状态` , 并把 `门牌勿扰asd` 关闭, 连带着清除 `勿扰状态`

### 2. 插卡动作组合
- 灯1 => 开
- 灯2 => 开
- 窗帘 => 开
- 窗纱 => 关
- 门牌入住指示灯 => 开
- ...
- 更改心跳 => 插卡(重要)

更改心跳-插卡会导致房间获得 `入住` 状态, 这是很重要的一个标记

拔卡的动作组合则应该执行 `更改心跳-拔卡`, 它会删除房间的 `入住` 状态

### 3. 门磁
`设备配置` 页:
- 类型(`灯`), 名称(`廊灯helo`), 通道(`1`)

`输入配置` 页:
- 名称(`门磁开`), 输入类型(`干接点输入`), 通道(`7`), 触发类型(`低电平`), 标记(`是门磁输入`, `拔卡时可用`, `忽略任意键执行`), 动作组:
    1. 廊灯helo => 开
    2. 延时 => 15秒
    3. 房间操作 => 如果存在此状态则跳出(入住)
    4. 廊灯helo => 关
    5. 更改心跳 => 拔卡

这样配置的话, 当用户初次开门, 首先会亮廊灯(`动作1`), 并点亮所有按键背光(`隐性行为`), 然后开始延时15秒(`动作2`), 此时有两个分支:
1. 用户在15秒之内插卡了
    - 如果插卡执行的动作组里有 `更改心跳-插卡` 使房间获得了 `入住` 状态
    - 当过了15秒, 开始执行 `动作3`, 此时发现房间存在 `入住` 状态, 就不会再执行下面的 `动作4` 和 `动作5`
    - 这是正常入住流程

2. 用户站在那不动, 过了15秒
    - 执行 `动作3`, 发现房间并不存在 `入住` 状态, 就会把 `廊灯helo` 关闭, 并使用 `更改心跳-拔卡` 来熄灭所有按键背光

### 4. 睡眠模式与任意键夜灯
`动作组合` 页:
- 名称(`睡眠模式aa`)
    - 灯1 => 关
    - 灯2 => 关
    - 灯3 => 关
    - 按键指示灯 => 灭 面板6按键0
    - 按键指示灯 => 灭 面板6按键1
    - 按键指示灯 => 亮1秒 面板6按键2
    - 按键指示灯 => 灭 面板6按键3
    - 窗帘 => 关
    - 更改心跳 => 睡眠
    - 动作组合 => 生成任意键执行 => 睡眠夜灯www

- 名称(`睡眠夜灯www`)
    - 灯3 => `开`

`输入配置` 页:
- 名称(`睡眠`), 输入类型(`面板按键`), 面板ID(`6`), 按键ID(`2`), 动作组:
    - 动作组合 => 调用 => 睡眠模式aa

其中面板6的按键0, 1, 3是别的情景模式, 所有这里执行 `睡眠模式aa` 会熄灭那三个指示灯并亮1秒自己的灯.

当按下面板6按键2时, 会调用 `睡眠模式aa`, 关闭各种设备后, 用 `更改心跳-睡眠` 来熄灭按键背光, 并生成一个 `任意键标记` 到 `睡眠夜灯www` 上

之后用户无论按什么按键, 只要那个按键没有 `忽略任意键执行` 的标记, 就会执行 `睡眠夜灯www` 而不是那个按键本身的功能